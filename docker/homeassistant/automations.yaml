# Example automations for PicoOpenTherm Gateway
# These are examples that users can enable/modify via the UI

# Low Water Pressure Alert
- id: opentherm_low_pressure_alert
  alias: OpenTherm - Low Water Pressure Alert
  description: Alert when CH water pressure is too low
  trigger:
    - platform: numeric_state
      entity_id: sensor.opentherm_gw_pressure
      below: 1.0
      for:
        minutes: 5
  condition: []
  action:
    - service: persistent_notification.create
      data:
        title: Low Boiler Pressure
        message: >
          Central heating water pressure is {{ states('sensor.opentherm_gw_pressure') }} bar.
          Normal pressure should be between 1.0 and 2.0 bar. Please check your heating system.
        notification_id: opentherm_low_pressure
  mode: single

# High Temperature Alert
- id: opentherm_high_temp_alert
  alias: OpenTherm - High Boiler Temperature Alert
  description: Alert when boiler water temperature is unusually high
  trigger:
    - platform: numeric_state
      entity_id: sensor.opentherm_gw_boiler_temp
      above: 80
      for:
        minutes: 5
  condition: []
  action:
    - service: persistent_notification.create
      data:
        title: High Boiler Temperature
        message: >
          Boiler water temperature is {{ states('sensor.opentherm_gw_boiler_temp') }}°C.
          This is unusually high. Please check your heating system.
        notification_id: opentherm_high_temp
  mode: single

# Gateway Offline Alert
- id: opentherm_gateway_offline
  alias: OpenTherm - Gateway Offline Alert
  description: Alert when the OpenTherm gateway goes offline
  trigger:
    - platform: state
      entity_id: sensor.opentherm_gw_status
      to: unavailable
      for:
        minutes: 5
  condition: []
  action:
    - service: persistent_notification.create
      data:
        title: OpenTherm Gateway Offline
        message: >
          The OpenTherm Gateway has been offline for 5 minutes.
          Please check the device connection and power.
        notification_id: opentherm_offline
  mode: single

# Fault Code Notification
- id: opentherm_fault_code
  alias: OpenTherm - Fault Code Notification
  description: Notify when boiler reports a fault code
  trigger:
    - platform: state
      entity_id: sensor.opentherm_gw_fault_code
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['0', 'unknown', 'unavailable'] }}"
  action:
    - service: persistent_notification.create
      data:
        title: Boiler Fault Detected
        message: >
          Boiler fault code: {{ states('sensor.opentherm_gw_fault_code') }}
          Diagnostic code: {{ states('sensor.opentherm_gw_diagnostic_code') }}
          Please check your boiler manual for details.
        notification_id: opentherm_fault
  mode: single

# Energy Efficiency - Reduce Setpoint at Night
- id: opentherm_night_setback
  alias: OpenTherm - Night Setback
  description: Lower room temperature setpoint at night to save energy
  trigger:
    - platform: time
      at: "22:00:00"
  condition: []
  action:
    - service: climate.set_temperature
      target:
        entity_id: climate.opentherm_thermostat
      data:
        temperature: 18
  mode: single

# Energy Efficiency - Morning Warmup
- id: opentherm_morning_warmup
  alias: OpenTherm - Morning Warmup
  description: Raise temperature in the morning
  trigger:
    - platform: time
      at: "06:00:00"
  condition: []
  action:
    - service: climate.set_temperature
      target:
        entity_id: climate.opentherm_thermostat
      data:
        temperature: 20
  mode: single

# Configuration Change Notification
- id: opentherm_config_changed
  alias: OpenTherm - Configuration Change Notification
  description: Notify when gateway configuration is changed
  trigger:
    - platform: state
      entity_id:
        - text.opentherm_gw_device_name
        - text.opentherm_gw_device_id
        - number.opentherm_gw_tx_pin
        - number.opentherm_gw_rx_pin
  condition: []
  action:
    - service: persistent_notification.create
      data:
        title: Gateway Configuration Changed
        message: >
          {{ trigger.to_state.attributes.friendly_name }} changed from 
          "{{ trigger.from_state.state }}" to "{{ trigger.to_state.state }}".
          The gateway will restart in a few seconds to apply changes.
        notification_id: opentherm_config_change
  mode: queued

# Daily Statistics Summary
- id: opentherm_daily_summary
  alias: OpenTherm - Daily Statistics Summary
  description: Create a daily summary of heating system usage
  trigger:
    - platform: time
      at: "23:59:00"
  condition: []
  action:
    - service: persistent_notification.create
      data:
        title: Daily Heating Summary
        message: >
          Today's heating statistics:
          - Burner starts: {{ states('sensor.opentherm_gw_burner_starts') }}
          - Average room temp: {{ states('sensor.opentherm_gw_room_temp') }}°C
          - Max boiler temp: {{ state_attr('sensor.opentherm_gw_boiler_temp', 'max_value') | default('N/A') }}°C
          - Current pressure: {{ states('sensor.opentherm_gw_pressure') }} bar
        notification_id: opentherm_daily_summary
  mode: single

# Time Synchronization - Daily Sync
- id: opentherm_daily_time_sync
  alias: OpenTherm - Daily Time Sync
  description: Synchronize boiler time daily at 3 AM
  trigger:
    - platform: time
      at: "03:00:00"
  condition: []
  action:
    - service: mqtt.publish
      data:
        topic: opentherm/cmd/sync_time
        payload: "{{ now().strftime('%Y-%m-%dT%H:%M:%S') }}"
  mode: single

# Time Synchronization - On HA Restart
- id: opentherm_time_sync_startup
  alias: OpenTherm - Time Sync on Startup
  description: Sync boiler time when Home Assistant restarts
  trigger:
    - platform: homeassistant
      event: start
  condition: []
  action:
    - delay: "00:01:00"
    - service: mqtt.publish
      data:
        topic: opentherm/cmd/sync_time
        payload: "{{ now().strftime('%Y-%m-%dT%H:%M:%S') }}"
  mode: single

# Time Synchronization - Manual Button
- id: opentherm_time_sync_button
  alias: OpenTherm - Manual Time Sync
  description: Sync time when sync button is pressed
  trigger:
    - platform: state
      entity_id: button.opentherm_gw_sync_time
  condition: []
  action:
    - service: mqtt.publish
      data:
        topic: opentherm/cmd/sync_time
        payload: "{{ now().strftime('%Y-%m-%dT%H:%M:%S') }}"
    - service: persistent_notification.create
      data:
        title: Time Sync Complete
        message: >
          Boiler time synchronized to: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
        notification_id: opentherm_time_sync
  mode: single

# Temperature Bounds Check
- id: opentherm_bounds_check
  alias: OpenTherm - Temperature Bounds Validation
  description: Alert when setpoint exceeds boiler-reported bounds
  trigger:
    - platform: state
      entity_id:
        - number.opentherm_gw_dhw_setpoint
        - number.opentherm_gw_max_ch_setpoint
  condition:
    - condition: template
      value_template: >
        {% set entity = trigger.entity_id %}
        {% set value = trigger.to_state.state | float(0) %}
        {% if 'dhw' in entity %}
          {% set min = states('sensor.opentherm_gw_dhw_setpoint_min') | float(30) %}
          {% set max = states('sensor.opentherm_gw_dhw_setpoint_max') | float(90) %}
        {% else %}
          {% set min = states('sensor.opentherm_gw_ch_setpoint_min') | float(30) %}
          {% set max = states('sensor.opentherm_gw_ch_setpoint_max') | float(90) %}
        {% endif %}
        {{ value < min or value > max }}
  action:
    - service: persistent_notification.create
      data:
        title: Setpoint Out of Bounds
        message: >
          {% set entity = trigger.entity_id %}
          {% set value = trigger.to_state.state | float(0) %}
          {% set name = state_attr(entity, 'friendly_name') | default('Setpoint') %}
          {% if 'dhw' in entity %}
            {% set min = states('sensor.opentherm_gw_dhw_setpoint_min') | float(30) %}
            {% set max = states('sensor.opentherm_gw_dhw_setpoint_max') | float(90) %}
          {% else %}
            {% set min = states('sensor.opentherm_gw_ch_setpoint_min') | float(30) %}
            {% set max = states('sensor.opentherm_gw_ch_setpoint_max') | float(90) %}
          {% endif %}
          Warning: {{ name }} set to {{ value }}°C
          Boiler valid range: {{ min }}°C - {{ max }}°C
          The boiler may reject this value.
        notification_id: opentherm_bounds_warning
  mode: queued

# WiFi Signal Strength Alert
- id: opentherm_wifi_weak_signal
  alias: OpenTherm - Weak WiFi Signal Alert
  description: Alert when WiFi signal is weak
  trigger:
    - platform: numeric_state
      entity_id: sensor.opentherm_gw_wifi_rssi
      below: -75
      for:
        minutes: 5
  condition: []
  action:
    - service: persistent_notification.create
      data:
        title: Weak WiFi Signal
        message: >
          OpenTherm Gateway WiFi signal is weak: {{ states('sensor.opentherm_gw_wifi_rssi') }} dBm
          Consider moving closer to WiFi router or adding WiFi extender.
        notification_id: opentherm_weak_wifi
  mode: single

# WiFi Disconnection Alert
- id: opentherm_wifi_disconnected
  alias: OpenTherm - WiFi Disconnected Alert
  description: Alert when WiFi connection is lost
  trigger:
    - platform: state
      entity_id: sensor.opentherm_gw_wifi_link_status
      from: connected
      for:
        minutes: 2
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'connected' }}"
  action:
    - service: persistent_notification.create
      data:
        title: WiFi Connection Lost
        message: >
          OpenTherm Gateway WiFi disconnected!
          Status: {{ states('sensor.opentherm_gw_wifi_link_status') }}
          Last known IP: {{ states('sensor.opentherm_gw_ip_address') }}
        notification_id: opentherm_wifi_disconnected
  mode: single

# WiFi Reconnection Notification
- id: opentherm_wifi_reconnected
  alias: OpenTherm - WiFi Reconnected
  description: Notify when WiFi reconnects after disconnection
  trigger:
    - platform: state
      entity_id: sensor.opentherm_gw_wifi_link_status
      to: connected
  condition:
    - condition: template
      value_template: "{{ trigger.from_state.state != 'connected' }}"
  action:
    - service: persistent_notification.create
      data:
        title: WiFi Reconnected
        message: >
          OpenTherm Gateway WiFi reconnected!
          IP Address: {{ states('sensor.opentherm_gw_ip_address') }}
          Signal: {{ states('sensor.opentherm_gw_wifi_rssi') }} dBm
        notification_id: opentherm_wifi_reconnected
    - delay: "00:00:05"
    - service: persistent_notification.dismiss
      data:
        notification_id: opentherm_wifi_disconnected
  mode: single
