# OpenTherm Gateway - Example Automations
# Common automation examples for OpenTherm control

# === HEATING SCHEDULES ===

# Morning heating schedule
- id: opentherm_morning_heating
  alias: "OpenTherm: Morning Heating"
  description: "Turn on heating and set temperature in the morning"
  trigger:
    - platform: time
      at: "06:00:00"
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.opentherm_gw_ch_enable
    - service: number.set_value
      target:
        entity_id: number.opentherm_gw_control_setpoint
      data:
        value: 65
    - service: number.set_value
      target:
        entity_id: number.opentherm_gw_room_setpoint
      data:
        value: 21

---

# Evening heating reduction
- id: opentherm_evening_reduction
  alias: "OpenTherm: Evening Reduction"
  description: "Lower heating temperature in the evening"
  trigger:
    - platform: time
      at: "22:00:00"
  action:
    - service: number.set_value
      target:
        entity_id: number.opentherm_gw_control_setpoint
      data:
        value: 55
    - service: number.set_value
      target:
        entity_id: number.opentherm_gw_room_setpoint
      data:
        value: 18

---

# Night heating off
- id: opentherm_night_off
  alias: "OpenTherm: Night Off"
  description: "Turn off heating at night"
  trigger:
    - platform: time
      at: "23:30:00"
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.opentherm_gw_ch_enable

---

# === HOT WATER CONTROL ===

# DHW temperature boost when low
- id: opentherm_dhw_boost
  alias: "OpenTherm: DHW Temperature Boost"
  description: "Boost DHW temperature when it drops below threshold"
  trigger:
    - platform: numeric_state
      entity_id: sensor.opentherm_gw_dhw_temp
      below: 45
  condition:
    - condition: state
      entity_id: switch.opentherm_gw_dhw_enable
      state: "on"
  action:
    - service: number.set_value
      target:
        entity_id: number.opentherm_gw_dhw_setpoint
      data:
        value: 60
    - service: notify.notify
      data:
        message: "DHW temperature low, boosting to 60Â°C"

---

# DHW economy mode at night
- id: opentherm_dhw_economy
  alias: "OpenTherm: DHW Economy Mode"
  description: "Lower DHW temperature at night to save energy"
  trigger:
    - platform: time
      at: "23:00:00"
  action:
    - service: number.set_value
      target:
        entity_id: number.opentherm_gw_dhw_setpoint
      data:
        value: 45

---

# === SAFETY AUTOMATIONS ===

# High temperature alert
- id: opentherm_high_temp_alert
  alias: "OpenTherm: High Temperature Alert"
  description: "Alert when boiler temperature is too high"
  trigger:
    - platform: numeric_state
      entity_id: sensor.opentherm_gw_boiler_temp
      above: 85
  action:
    - service: notify.notify
      data:
        title: "âš ï¸ High Boiler Temperature"
        message: "Boiler temperature is {{ states('sensor.opentherm_gw_boiler_temp') }}Â°C"
    - service: persistent_notification.create
      data:
        title: "High Boiler Temperature"
        message: "Boiler temperature is {{ states('sensor.opentherm_gw_boiler_temp') }}Â°C"

---

# Low pressure alert
- id: opentherm_low_pressure_alert
  alias: "OpenTherm: Low Pressure Alert"
  description: "Alert when system pressure is too low"
  trigger:
    - platform: numeric_state
      entity_id: sensor.opentherm_gw_pressure
      below: 0.8
  action:
    - service: notify.notify
      data:
        title: "âš ï¸ Low System Pressure"
        message: "CH pressure is {{ states('sensor.opentherm_gw_pressure') }} bar - please top up"

---

# Fault detection
- id: opentherm_fault_alert
  alias: "OpenTherm: Fault Alert"
  description: "Alert when system fault is detected"
  trigger:
    - platform: state
      entity_id: binary_sensor.opentherm_gw_fault
      to: "on"
  action:
    - service: notify.notify
      data:
        title: "ðŸš¨ OpenTherm Fault Detected"
        message: "Fault code: {{ states('sensor.opentherm_gw_fault_code') }}"
    - service: persistent_notification.create
      data:
        title: "OpenTherm System Fault"
        message: |
          Fault detected at {{ now().strftime('%H:%M:%S') }}
          Fault code: {{ states('sensor.opentherm_gw_fault_code') }}
          Please check your boiler display.

---

# === WEATHER-BASED CONTROL ===

# Weather compensation
- id: opentherm_weather_compensation
  alias: "OpenTherm: Weather Compensation"
  description: "Adjust heating based on outside temperature"
  trigger:
    - platform: state
      entity_id: sensor.opentherm_gw_outside_temp
  condition:
    - condition: state
      entity_id: switch.opentherm_gw_ch_enable
      state: "on"
  action:
    - service: number.set_value
      target:
        entity_id: number.opentherm_gw_control_setpoint
      data:
        value: >
          {% set outside = states('sensor.opentherm_gw_outside_temp') | float %}
          {% if outside < -5 %}
            75
          {% elif outside < 0 %}
            70
          {% elif outside < 5 %}
            65
          {% elif outside < 10 %}
            60
          {% elif outside < 15 %}
            55
          {% else %}
            50
          {% endif %}

---

# === PRESENCE-BASED CONTROL ===

# Away mode
- id: opentherm_away_mode
  alias: "OpenTherm: Away Mode"
  description: "Lower heating when nobody is home"
  trigger:
    - platform: state
      entity_id: group.all_persons
      to: "not_home"
      for:
        minutes: 30
  action:
    - service: number.set_value
      target:
        entity_id: number.opentherm_gw_control_setpoint
      data:
        value: 50
    - service: number.set_value
      target:
        entity_id: number.opentherm_gw_room_setpoint
      data:
        value: 16

---

# Home mode
- id: opentherm_home_mode
  alias: "OpenTherm: Home Mode"
  description: "Resume normal heating when someone arrives home"
  trigger:
    - platform: state
      entity_id: group.all_persons
      to: "home"
  action:
    - service: number.set_value
      target:
        entity_id: number.opentherm_gw_control_setpoint
      data:
        value: 65
    - service: number.set_value
      target:
        entity_id: number.opentherm_gw_room_setpoint
      data:
        value: 21

---

# === EFFICIENCY MONITORING ===

# High modulation alert (inefficient operation)
- id: opentherm_high_modulation_alert
  alias: "OpenTherm: High Modulation Alert"
  description: "Alert when modulation is consistently high"
  trigger:
    - platform: numeric_state
      entity_id: sensor.opentherm_gw_modulation
      above: 90
      for:
        minutes: 15
  action:
    - service: notify.notify
      data:
        message: "Boiler running at high modulation ({{ states('sensor.opentherm_gw_modulation') }}%) for 15 minutes"

---

# Daily statistics report
- id: opentherm_daily_report
  alias: "OpenTherm: Daily Statistics Report"
  description: "Send daily heating statistics"
  trigger:
    - platform: time
      at: "20:00:00"
  action:
    - service: notify.notify
      data:
        title: "Daily Heating Report"
        message: |
          Burner Hours: {{ states('sensor.opentherm_gw_burner_hours') }}h
          CH Pump Hours: {{ states('sensor.opentherm_gw_ch_pump_hours') }}h
          Average Boiler Temp: {{ states('sensor.opentherm_gw_boiler_temp') }}Â°C
          Current Pressure: {{ states('sensor.opentherm_gw_pressure') }} bar

---

# === TIME SYNCHRONIZATION ===

# Daily time sync at 3 AM
- id: opentherm_daily_time_sync
  alias: "OpenTherm: Daily Time Sync"
  description: "Sync boiler time daily at 3 AM"
  trigger:
    - platform: time
      at: "03:00:00"
  action:
    - service: mqtt.publish
      data:
        topic: "opentherm/opentherm_gw/cmd/sync_time"
        payload: "{{ now().strftime('%Y-%m-%dT%H:%M:%S') }}"
    - service: logbook.log
      data:
        name: OpenTherm Time Sync
        message: "Boiler time synchronized at {{ now().strftime('%H:%M:%S') }}"

---

# Sync time on Home Assistant startup
- id: opentherm_time_sync_on_startup
  alias: "OpenTherm: Time Sync on HA Startup"
  description: "Sync boiler time when Home Assistant starts"
  trigger:
    - platform: homeassistant
      event: start
  action:
    - delay: "00:01:00"  # Wait for MQTT connection
    - service: mqtt.publish
      data:
        topic: "opentherm/opentherm_gw/cmd/sync_time"
        payload: "{{ now().strftime('%Y-%m-%dT%H:%M:%S') }}"
    - service: logbook.log
      data:
        name: OpenTherm Time Sync
        message: "Boiler time synchronized on HA startup"

---

# Sync time on button press (manual trigger)
- id: opentherm_time_sync_button
  alias: "OpenTherm: Sync Time Button"
  description: "Sync boiler time when button is pressed"
  trigger:
    - platform: state
      entity_id: button.opentherm_gw_sync_time
  action:
    - service: mqtt.publish
      data:
        topic: "opentherm/opentherm_gw/cmd/sync_time"
        payload: "{{ now().strftime('%Y-%m-%dT%H:%M:%S') }}"
    - service: persistent_notification.create
      data:
        title: "â° Time Sync Requested"
        message: |
          Syncing current time to boiler:
          {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
          Day of week: {{ now().strftime('%A') }}
        notification_id: opentherm_time_sync

---

# Sync time after DST changes (spring forward)
- id: opentherm_time_sync_dst_spring
  alias: "OpenTherm: Time Sync DST Spring"
  description: "Sync boiler time after daylight saving time changes (spring)"
  trigger:
    - platform: time
      at: "02:30:00"
  condition:
    # Last Sunday in March for Europe, second Sunday in March for US
    - condition: template
      value_template: >
        {% set today = now() %}
        {{ today.month == 3 and today.weekday() == 6 and
           (today.day >= 25 or (today.day >= 8 and today.day <= 14)) }}
  action:
    - service: mqtt.publish
      data:
        topic: "opentherm/opentherm_gw/cmd/sync_time"
        payload: "{{ now().strftime('%Y-%m-%dT%H:%M:%S') }}"
    - service: persistent_notification.create
      data:
        title: "â° DST Time Sync"
        message: "Boiler time synchronized after spring DST change"

---

# Sync time after DST changes (fall back)
- id: opentherm_time_sync_dst_fall
  alias: "OpenTherm: Time Sync DST Fall"
  description: "Sync boiler time after daylight saving time changes (fall)"
  trigger:
    - platform: time
      at: "02:30:00"
  condition:
    # Last Sunday in October for Europe, first Sunday in November for US
    - condition: template
      value_template: >
        {% set today = now() %}
        {{ (today.month == 10 and today.weekday() == 6 and today.day >= 25) or
           (today.month == 11 and today.weekday() == 6 and today.day <= 7) }}
  action:
    - service: mqtt.publish
      data:
        topic: "opentherm/opentherm_gw/cmd/sync_time"
        payload: "{{ now().strftime('%Y-%m-%dT%H:%M:%S') }}"
    - service: persistent_notification.create
      data:
        title: "â° DST Time Sync"
        message: "Boiler time synchronized after fall DST change"

---

# === TIME/DATE MONITORING ===

# Alert when boiler time drifts significantly
- id: opentherm_time_drift_alert
  alias: "OpenTherm: Time Drift Alert"
  description: "Alert when boiler time differs significantly from system time"
  trigger:
    - platform: time_pattern
      hours: "*"
      minutes: "*/30"
  condition:
    # Check if time_of_day sensor exists and has a value
    - condition: template
      value_template: "{{ states('sensor.opentherm_gw_time_of_day') not in ['unknown', 'unavailable'] }}"
  action:
    - service: script.check_boiler_time_drift
      # This script would need to be created separately
      # It would parse the boiler time and compare it to system time

---

# === TEMPERATURE BOUNDS MONITORING ===

# Alert if setpoint exceeds bounds
- id: opentherm_setpoint_bounds_check
  alias: "OpenTherm: Setpoint Bounds Check"
  description: "Alert if requested setpoint exceeds boiler bounds"
  trigger:
    - platform: state
      entity_id:
        - number.opentherm_gw_dhw_setpoint
        - number.opentherm_gw_max_ch_setpoint
  condition:
    - condition: template
      value_template: >
        {% set entity = trigger.entity_id %}
        {% set value = trigger.to_state.state | float %}
        {% if 'dhw' in entity %}
          {% set min = states('sensor.opentherm_gw_dhw_setpoint_min') | float %}
          {% set max = states('sensor.opentherm_gw_dhw_setpoint_max') | float %}
        {% else %}
          {% set min = states('sensor.opentherm_gw_ch_setpoint_min') | float %}
          {% set max = states('sensor.opentherm_gw_ch_setpoint_max') | float %}
        {% endif %}
        {{ value < min or value > max }}
  action:
    - service: persistent_notification.create
      data:
        title: "âš ï¸ Setpoint Out of Bounds"
        message: >
          {% set entity = trigger.entity_id %}
          {% set value = trigger.to_state.state | float %}
          {% set name = state_attr(entity, 'friendly_name') %}
          {% if 'dhw' in entity %}
            {% set min = states('sensor.opentherm_gw_dhw_setpoint_min') | float %}
            {% set max = states('sensor.opentherm_gw_dhw_setpoint_max') | float %}
          {% else %}
            {% set min = states('sensor.opentherm_gw_ch_setpoint_min') | float %}
            {% set max = states('sensor.opentherm_gw_ch_setpoint_max') | float %}
          {% endif %}
          {{ name }}: {{ value }}Â°C
          Valid range: {{ min }}Â°C - {{ max }}Â°C

          The boiler may reject this setpoint.

---

# === WIFI MONITORING ===

# WiFi Signal Strength Alert
- id: opentherm_wifi_weak_signal
  alias: "OpenTherm: Weak WiFi Signal Alert"
  description: "Alert when WiFi signal is weak"
  trigger:
    - platform: numeric_state
      entity_id: sensor.opentherm_gw_wifi_rssi
      below: -75
      for:
        minutes: 5
  action:
    - service: persistent_notification.create
      data:
        title: "âš ï¸ Weak WiFi Signal"
        message: >
          OpenTherm Gateway WiFi signal is weak: {{ states('sensor.opentherm_gw_wifi_rssi') }} dBm
          Consider moving closer to WiFi router or adding WiFi extender.
        notification_id: opentherm_weak_wifi

---

# WiFi Disconnection Alert
- id: opentherm_wifi_disconnected
  alias: "OpenTherm: WiFi Disconnected Alert"
  description: "Alert when WiFi connection is lost"
  trigger:
    - platform: state
      entity_id: sensor.opentherm_gw_wifi_link_status
      from: "connected"
      for:
        minutes: 2
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'connected' }}"
  action:
    - service: persistent_notification.create
      data:
        title: "ðŸš¨ WiFi Connection Lost"
        message: >
          OpenTherm Gateway WiFi disconnected!
          Status: {{ states('sensor.opentherm_gw_wifi_link_status') }}
          Last known IP: {{ states('sensor.opentherm_gw_ip_address') }}
        notification_id: opentherm_wifi_disconnected

---

# WiFi Reconnection Notification
- id: opentherm_wifi_reconnected
  alias: "OpenTherm: WiFi Reconnected"
  description: "Notify when WiFi reconnects after disconnection"
  trigger:
    - platform: state
      entity_id: sensor.opentherm_gw_wifi_link_status
      to: "connected"
  condition:
    - condition: template
      value_template: "{{ trigger.from_state.state != 'connected' }}"
  action:
    - service: persistent_notification.create
      data:
        title: "âœ… WiFi Reconnected"
        message: >
          OpenTherm Gateway WiFi reconnected!
          IP Address: {{ states('sensor.opentherm_gw_ip_address') }}
          Signal: {{ states('sensor.opentherm_gw_wifi_rssi') }} dBm
        notification_id: opentherm_wifi_reconnected
    - delay: "00:00:05"
    - service: persistent_notification.dismiss
      data:
        notification_id: opentherm_wifi_disconnected

---

# Daily WiFi Statistics Report
- id: opentherm_daily_wifi_report
  alias: "OpenTherm: Daily WiFi Statistics"
  description: "Daily report of WiFi connection quality"
  trigger:
    - platform: time
      at: "23:55:00"
  action:
    - service: notify.notify
      data:
        title: "OpenTherm WiFi Daily Report"
        message: >
          WiFi Statistics for {{ now().strftime('%Y-%m-%d') }}:
          - Signal Strength: {{ states('sensor.opentherm_gw_wifi_rssi') }} dBm
          - Link Status: {{ states('sensor.opentherm_gw_wifi_link_status') }}
          - IP Address: {{ states('sensor.opentherm_gw_ip_address') }}
          - SSID: {{ states('sensor.opentherm_gw_wifi_ssid') }}
          - Uptime: {{ (states('sensor.opentherm_gw_uptime') | int / 3600) | round(1) }} hours
