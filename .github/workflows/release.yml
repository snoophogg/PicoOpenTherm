name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Initialize submodules
      run: |
        git submodule update --init --recursive
    
    - name: Install ARM toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake
    
    - name: Build picotool
      run: |
        export PICO_SDK_PATH=$GITHUB_WORKSPACE/pico-sdk
        cd picotool
        mkdir -p build
        cd build
        cmake ..
        make -j$(nproc)
    
    - name: Build firmware
      run: |
        mkdir -p build
        cd build
        cmake -DPICO_BOARD=pico_w -DCMAKE_BUILD_TYPE=Release ..
        make -j$(nproc)
        make picoopentherm_simulator -j$(nproc)
    
    - name: Build kvstore-util
      run: |
        # Manually fetch and prepare SDK 2.1.1 for kvstore-util
        mkdir -p pico-kvstore/host/build/sdk
        cd pico-kvstore/host/build/sdk
        if [ ! -d pico-sdk ]; then
          echo "Fetching Pico SDK 2.1.1..."
          git clone --branch 2.1.1 https://github.com/raspberrypi/pico-sdk.git
          cd pico-sdk
          git submodule update --init --recursive
          cd ..
        fi
        cd ../..
        # Now configure with the manually fetched SDK
        export PICO_SDK_PATH=$PWD/build/sdk/pico-sdk
        cmake ..
        make -j$(nproc)
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create release archive
      run: |
        mkdir -p release
        cp build/picoopentherm.uf2 release/picoopentherm-${{ steps.get_version.outputs.VERSION }}.uf2
        cp build/picoopentherm.elf release/picoopentherm-${{ steps.get_version.outputs.VERSION }}.elf
        cp build/picoopentherm.bin release/picoopentherm-${{ steps.get_version.outputs.VERSION }}.bin
        cp build/picoopentherm_simulator.uf2 release/picoopentherm_simulator-${{ steps.get_version.outputs.VERSION }}.uf2
        cp build/picoopentherm_simulator.elf release/picoopentherm_simulator-${{ steps.get_version.outputs.VERSION }}.elf
        cp build/picoopentherm_simulator.bin release/picoopentherm_simulator-${{ steps.get_version.outputs.VERSION }}.bin
        cp picotool/build/picotool release/picotool-linux-amd64-${{ steps.get_version.outputs.VERSION }}
        chmod +x release/picotool-linux-amd64-${{ steps.get_version.outputs.VERSION }}
        cp pico-kvstore/host/build/kvstore-util release/kvstore-util-linux-amd64-${{ steps.get_version.outputs.VERSION }}
        chmod +x release/kvstore-util-linux-amd64-${{ steps.get_version.outputs.VERSION }}
        cd release
        sha256sum * > checksums.txt
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/picoopentherm-${{ steps.get_version.outputs.VERSION }}.uf2
          release/picoopentherm-${{ steps.get_version.outputs.VERSION }}.elf
          release/picoopentherm-${{ steps.get_version.outputs.VERSION }}.bin
          release/picoopentherm_simulator-${{ steps.get_version.outputs.VERSION }}.uf2
          release/picoopentherm_simulator-${{ steps.get_version.outputs.VERSION }}.elf
          release/picoopentherm_simulator-${{ steps.get_version.outputs.VERSION }}.bin
          release/picotool-linux-amd64-${{ steps.get_version.outputs.VERSION }}
          release/kvstore-util-linux-amd64-${{ steps.get_version.outputs.VERSION }}
          release/checksums.txt
        body: |
          ## PicoOpenTherm ${{ steps.get_version.outputs.VERSION }}
          
          OpenTherm v2.2 Gateway for Raspberry Pi Pico W with Home Assistant MQTT integration.
          
          ### Installation
          
          1. Download `picoopentherm-${{ steps.get_version.outputs.VERSION }}.uf2`
          2. Hold BOOTSEL button on your Pico W and connect to USB
          3. Copy the .uf2 file to the Pico W drive
          4. The device will automatically reboot and start running
          
          ### Simulator
          
          The simulator firmware (`picoopentherm_simulator-${{ steps.get_version.outputs.VERSION }}.uf2`) provides simulated OpenTherm data for testing Home Assistant integration without physical hardware. It generates realistic temperature, pressure, and modulation values with dynamic behavior.
          
          ### Configuration
          
          Before flashing, update WiFi and MQTT settings in `src/main.cpp`:
          - WiFi SSID and password
          - MQTT broker IP and port
          
          See [README.md](https://github.com/snoophogg/PicoOpenTherm/blob/main/README.md) for full documentation.
          
          ### Files
          
          **Main Firmware:**
          - **picoopentherm.uf2** - Ready to flash firmware (recommended)
          - **picoopentherm.elf** - Executable with debug symbols
          - **picoopentherm.bin** - Raw binary image
          
          **Simulator Firmware:**
          - **picoopentherm_simulator.uf2** - Simulator for testing without hardware
          - **picoopentherm_simulator.elf** - Simulator with debug symbols
          - **picoopentherm_simulator.bin** - Simulator raw binary
          
          **Tools (Linux x64):**
          - **picotool-linux-amd64** - Flash and manage Pico devices from Linux
          - **kvstore-util-linux-amd64** - Provision configuration data (built with SDK 2.1.1)
          
          **Verification:**
          - **checksums.txt** - SHA256 checksums for verification
        draft: false
        prerelease: false
