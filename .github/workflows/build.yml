name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Initialize submodules
      run: |
        git submodule update --init --recursive
    
    - name: Install ARM toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake
    
    - name: Build firmware
      run: |
        mkdir -p build
        cd build
        cmake -DPICO_BOARD=pico_w ..
        make -j$(nproc)
    
    - name: Build simulator
      run: |
        cd build
        make picoopentherm_simulator -j$(nproc)
    
    - name: Build picotool
      run: |
        export PICO_SDK_PATH=$GITHUB_WORKSPACE/pico-sdk
        cd picotool
        mkdir -p build
        cd build
        cmake ..
        make -j$(nproc)
    
    - name: Build kvstore-util
      run: |
        cd pico-kvstore/tools
        make kvstore-util
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: picoopentherm-firmware
        path: |
          build/picoopentherm.uf2
          build/picoopentherm.elf
          build/picoopentherm.bin
          build/picoopentherm_simulator.uf2
          build/picoopentherm_simulator.elf
          build/picoopentherm_simulator.bin
        retention-days: 30
    
    - name: Upload tools artifacts
      uses: actions/upload-artifact@v4
      with:
        name: picoopentherm-tools
        path: |
          picotool/build/picotool
          pico-kvstore/tools/kvstore-util
        retention-days: 30
    
    - name: Build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Firmware built successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Main Firmware" >> $GITHUB_STEP_SUMMARY
        echo "- \`picoopentherm.uf2\` - Ready to flash to Pico W" >> $GITHUB_STEP_SUMMARY
        echo "- \`picoopentherm.elf\` - Executable with debug symbols" >> $GITHUB_STEP_SUMMARY
        echo "- \`picoopentherm.bin\` - Raw binary image" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        ls -lh build/picoopentherm.uf2 build/picoopentherm.elf build/picoopentherm.bin >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Simulator Firmware" >> $GITHUB_STEP_SUMMARY
        echo "- \`picoopentherm_simulator.uf2\` - Simulator for testing without hardware" >> $GITHUB_STEP_SUMMARY
        echo "- \`picoopentherm_simulator.elf\` - Simulator with debug symbols" >> $GITHUB_STEP_SUMMARY
        echo "- \`picoopentherm_simulator.bin\` - Simulator raw binary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        ls -lh build/picoopentherm_simulator.uf2 build/picoopentherm_simulator.elf build/picoopentherm_simulator.bin >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tools" >> $GITHUB_STEP_SUMMARY
        echo "- \`picotool\` - Flash and manage Pico devices" >> $GITHUB_STEP_SUMMARY
        echo "- \`kvstore-util\` - Configuration provisioning tool" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        ls -lh picotool/build/picotool pico-kvstore/tools/kvstore-util >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
